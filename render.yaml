services:
  # Backend API + WebSocket server
  - type: web
    name: orderflow-backend
    runtime: python
    rootDir: backend
    region: singapore     # Closest Render region to NSE/Dhan servers (Mumbai). Cuts ~200ms vs US.
    plan: starter         # Starter required for Render Disk + no spin-down on inactivity
    buildCommand: pip install -r requirements.txt
    startCommand: uvicorn main:app --host 0.0.0.0 --port $PORT
    disk:
      name: orderflow-data
      mountPath: /data
      sizeGB: 1             # 1 GB ~ $0.25/month; holds years of candle snapshots
    envVars:
      - key: DHAN_CLIENT_ID
        sync: false
      - key: DHAN_ACCESS_TOKEN
        sync: false
      - key: CANDLE_SECONDS
        value: "60"
      - key: IMBALANCE_RATIO
        value: "3.0"
      - key: MAX_CANDLES_PER_SYMBOL
        value: "400"          # max candles kept on disk per symbol (full NSE session = 375)
      - key: MAX_CANDLES_IN_MEMORY
        value: "20"           # closed candles kept in RAM per engine; rest live on disk
      - key: MAX_LEVELS_PER_CANDLE
        value: "150"          # 150 price levels per candle is more than enough
      - key: MAX_ENGINES
        value: "1000"         # no cap — all CSV instruments get engines (RAM is flat at 20 candles each)
      - key: GC_INTERVAL_TICKS
        value: "10000"
      - key: BROADCAST_MIN_INTERVAL
        value: "0.1"          # 100ms = 10 updates/sec max per symbol
      - key: BROADCAST_CANDLES_LIMIT
        value: "5"            # live tick broadcasts send only last 5 candles; full history via request_history
      - key: SNAPSHOT_DIR
        value: /data/snapshots
      # ── Liquidity Heatmap token (separate Dhan account) ──────────────────────
      # Polls /v2/marketfeed/full every 1 s for NIFTY/BANKNIFTY order book.
      # Leave blank to disable the depth poller (heatmap tab will show "no data").
      # 200-level depth WebSocket — wss://full-depth-api.dhan.co/twohundreddepth
      - key: DHAN_TOKEN_DEPTH
        sync: false             # set manually in Render dashboard
      - key: HEATMAP_SNAPSHOTS
        value: "300"            # rolling snapshots kept per symbol (≈5 min of depth history)
      # ── Options GEX token (separate Dhan account) ────────────────────────────
      # Polls /v2/optionchain every 60 s for NIFTY/BANKNIFTY options chain.
      # Leave blank to disable the GEX poller (GEX tab will show "no data").
      - key: DHAN_TOKEN_OPTIONS
        sync: false             # set manually in Render dashboard
      - key: OPTIONS_POLL_SEC
        value: "300"          # 5 min between full cycles; 5 s gap between each index
    healthCheckPath: /api/health

  # Frontend static site
  - type: web
    name: orderflow-frontend
    runtime: static
    rootDir: frontend
    buildCommand: npm install && npm run build
    staticPublishPath: dist
    envVars:
      - key: VITE_WS_URL
        value: wss://orderflow-backend.onrender.com/ws
      - key: VITE_API_URL
        value: https://orderflow-backend.onrender.com
    routes:
      - type: rewrite
        source: /*
        destination: /index.html
